{% extends 'base.html' %}
{% block title %}Dashboard - Lavanderia{% endblock %}
{% block content %}
<style>
  .dash-title { display: flex; align-items: center; gap: .5rem; }
  .dash-title .icon { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(13,110,253,.08); color: #0d6efd; }
  .dash-title .text { font-weight: 800; font-size: 1.5rem; letter-spacing: .3px; background: linear-gradient(90deg, #0d6efd, #198754); -webkit-background-clip: text; background-clip: text; color: transparent; }
  .dash-toolbar-top { top: 64px; z-index: 1029; }
  @media (max-width: 576px){ .dash-toolbar-top { top: 56px; } }
</style>
<div class="dash-toolbar-top sticky-top bg-body border-bottom shadow-sm mb-3">
  <div class="container py-2 d-flex align-items-center">
    <div class="dash-title">
      <span class="icon"><i class="bi bi-speedometer2"></i></span>
      <span class="text">Dashboard</span>
    </div>
  </div>
 </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<div class="row g-3">
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-receipt fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Ordens hoje</div>
          <div class="h4 mb-0">{{ (metrics and metrics.today_orders) or 0 }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-warning bg-opacity-10 text-warning d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-hourglass-split fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Em aberto</div>
          <div class="h4 mb-0">{{ (metrics and metrics.open_orders) or 0 }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-info bg-opacity-10 text-info d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-truck fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Entregas hoje</div>
          <div class="h4 mb-0">{{ (metrics and metrics.today_deliveries) or 0 }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-success bg-opacity-10 text-success d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-cash-coin fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Receita (7 dias)</div>
          <div class="h4 mb-0">R$ {{ ((metrics and metrics.revenue_7d) or 0)|money_br }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-secondary bg-opacity-10 text-secondary d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-check2-circle fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Quitadas hoje</div>
          <div class="h4 mb-0">{{ (metrics and metrics.paid_today) or 0 }}</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <div class="rounded-circle bg-dark bg-opacity-10 text-dark d-flex align-items-center justify-content-center me-3" style="width:44px;height:44px;">
          <i class="bi bi-person-plus fs-5"></i>
        </div>
        <div>
          <div class="text-muted small">Novos clientes (7 dias)</div>
          <div class="h4 mb-0">{{ (metrics and metrics.new_clients_7d) or 0 }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Tendências (7 dias)</span>
        <small class="text-muted">Ordens criadas e Receita por dia</small>
      </div>
      <div class="card-body">
        <canvas id="trendChart" height="120"></canvas>
        <script id="trendData" type="application/json">{{ (trends or {})|tojson }}</script>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Ordens recentes</span>
        <a href="{{ url_for('orders.list_orders') }}" class="small">Ver todas</a>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Status</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for o in (recent_orders or []) %}
              <tr>
                <td><a href="{{ url_for('orders.edit_order', order_id=o.id) }}">#{{ o.id }}</a></td>
                <td>{{ o.client and o.client.name or '-' }}</td>
                <td>{{ o.status or '-' }}</td>
                <td class="text-end">R$ {{ (o.total or 0)|money_br }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">Nenhuma ordem recente</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header">Ações rápidas</div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('orders.create_order') }}" class="btn btn-outline-primary"><i class="bi bi-plus-lg me-1"></i> Nova Ordem</a>
          <a href="{{ url_for('clients.list_clients') }}" class="btn btn-outline-secondary"><i class="bi bi-people me-1"></i> Clientes</a>
          <a href="{{ url_for('services.list_services') }}" class="btn btn-outline-secondary"><i class="bi bi-gear me-1"></i> Serviços</a>
          <a href="{{ url_for('orders.list_orders', pay='em_aberto') }}" class="btn btn-outline-warning text-dark"><i class="bi bi-exclamation-circle me-1"></i> Ordens em aberto</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    try {
      var dataNode = document.getElementById('trendData');
      var json = dataNode ? JSON.parse(dataNode.textContent || '{}') : {};
      var labels = Array.isArray(json.labels) ? json.labels : [];
      var orders = Array.isArray(json.orders) ? json.orders : [];
      var revenue = Array.isArray(json.revenue) ? json.revenue : [];
      var ctx = document.getElementById('trendChart');
      if (ctx && labels.length) {
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              { label: 'Ordens', data: orders, borderColor: 'rgba(13,110,253,1)', backgroundColor: 'rgba(13,110,253,0.1)', tension: .3, borderWidth: 2, pointRadius: 2, yAxisID: 'y1' },
              { label: 'Receita (R$)', data: revenue, borderColor: 'rgba(25,135,84,1)', backgroundColor: 'rgba(25,135,84,0.1)', tension: .3, borderWidth: 2, pointRadius: 2, yAxisID: 'y2' }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y1: { type: 'linear', position: 'left', ticks: { precision: 0 } },
              y2: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: function(v){ return 'R$ ' + Number(v).toLocaleString('pt-BR'); } } },
            },
            plugins: {
              legend: { display: true },
              tooltip: { callbacks: { label: function(ctx){ if (ctx.datasetIndex === 1) { return ctx.dataset.label + ': R$ ' + Number(ctx.parsed.y).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); } return ctx.dataset.label + ': ' + ctx.parsed.y; } } }
            }
          }
        });
      }
    } catch(e) {}
  })();
</script>

{% endblock %}
